<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANARO ‚Äî Checkout</title>
  <style>
    :root{--bg:#fffdf9;--text:#2a221d;--muted:#6e625a;--border:#eadfd4;--brand:#7a4b2b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:22px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{margin:0 0 8px 0;font-size:16px}
    label{font-size:13px;font-weight:700;color:#6b3f25}
    input[type="text"], input[type="email"], textarea{padding:10px;border:1px solid #0002;border-radius:10px;width:100%}
    input.required{border-color:#e74c3c}
    input.valid{border-color:#27ae60}
    .error{color:#e74c3c;font-size:12px;margin-top:4px}
    textarea{min-height:90px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gender{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .opt{display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid #0001;border-radius:10px;background:#0001;cursor:pointer}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #0001;background:#0001;color:#1e1e1e;font-weight:800;cursor:pointer;text-decoration:none}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .cta{background:#F8EBDD;border-color:transparent}
    .loading{background:#ddd;color:#666}
    .srow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ico{width:18px;height:18px;display:inline-block}
    footer{margin-top:24px;color:#6e625a;font-size:12px;text-align:center}
    .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#2a221d;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999}

    .payment-methods{margin-top:12px}
    .payment-info{display:flex;gap:8px;align-items:center;padding:12px;border:1px solid var(--brand);border-radius:10px;background:#F8EBDD;margin-bottom:8px}
    .payment-info .ico{color:var(--brand)}

    .backdrop{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(520px,92vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 40px #0005;padding:16px}
    .modal h3{margin:0 0 6px}
    .modal p{margin:6px 0;color:var(--muted)}
    .modal .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .modal .btn{background:#0001}
    .modal .cta{background:#F8EBDD}

    .transfer-info{margin-top:12px}
    .bank-option{margin-bottom:12px;padding:12px;border:1px solid var(--border);border-radius:10px;background:#f9f9f9}
    .bank-header{font-weight:700;margin-bottom:8px;color:var(--brand)}
    .bank-details{font-size:14px}
    .detail-row{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
    .copy-group{display:flex;align-items:center;gap:6px}
    .copy-btn{background:#F8EBDD;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
    .copy-btn:hover{background:#e6d4c4}
    .transfer-amount{margin-top:16px;padding:12px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:10px}
    .amount-info .detail-row{margin:6px 0}
    .order-code{margin-top:8px;padding:8px 12px;background:#f0f8f0;border:1px solid #d4e6f1;border-radius:8px;text-align:center}
    .order-code strong{color:var(--brand);font-size:14px}
  
    @media (max-width: 768px) {
      .grid{grid-template-columns:1fr}
      .row2{grid-template-columns:1fr}
      .gender{grid-template-columns:1fr 1fr}
      .srow{flex-direction:column}
      .modal{width:95vw}
      .detail-row{flex-direction:column;align-items:flex-start;gap:4px}
      .copy-group{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚òï ANARO COFFEE ‚Äî Thanh to√°n</h1>
      <a class="btn" href="index.html">‚Üê Ti·∫øp t·ª•c mua</a>
    </header>

    <div class="grid">
      <!-- LEFT: Customer Info -->
      <section class="card">
        <h2 class="title">Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>
        <div class="row2">
          <div>
            <label for="recipient">T√™n ng∆∞·ªùi nh·∫≠n *</label>
            <input id="recipient" type="text" placeholder="VD: Nguy·ªÖn VƒÉn A" required />
            <div class="error" id="recipientError"></div>
          </div>
          <div>
            <label>Gi·ªõi t√≠nh (x∆∞ng h√¥) *</label>
            <div class="gender">
              <label class="opt"><input type="radio" name="gender" value="Anh" checked /> Anh</label>
              <label class="opt"><input type="radio" name="gender" value="Ch·ªã" /> Ch·ªã</label>
              <label class="opt"><input type="radio" name="gender" value="Kh√°c" /> Kh√°c</label>
            </div>
          </div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label for="email">Email *</label>
            <input id="email" type="email" placeholder="you@example.com" required />
            <div class="error" id="emailError"></div>
          </div>
          <div>
            <label for="phone">S·ªë ƒëi·ªán tho·∫°i *</label>
            <input id="phone" type="text" placeholder="09xx xxx xxx" required />
            <div class="error" id="phoneError"></div>
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="address">ƒê·ªãa ch·ªâ *</label>
          <input id="address" type="text" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh" required />
          <div class="error" id="addressError"></div>
        </div>
        <div style="margin-top:10px">
          <label for="note">Ghi ch√∫</label>
          <textarea id="note" placeholder="Ghi ch√∫ th√™m (khung gi·ªù nh·∫≠n, ƒë·ªãa ch·ªâ chi ti·∫øt, v.v.)"></textarea>
        </div>

        <h3 class="title" style="margin-top:14px">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
        <div class="payment-methods">
          <div class="payment-info">
            <span class="ico">üì±</span>
            <span><strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong> - Momo/VCB/MBBank</span>
          </div>
          <input type="hidden" name="payment" value="transfer" />
        </div>

        <h3 class="title" style="margin-top:14px">Li√™n h·ªá / X√°c nh·∫≠n ƒë∆°n</h3>
        <div class="srow">
          <a id="linkZalo" class="btn" target="_blank" rel="noopener" href="#" aria-label="Zalo">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#0068FF"/><text x="6.7" y="16.5" font-family="Segoe UI, Roboto, Helvetica, Arial" font-size="10" fill="#fff" font-weight="700">Z</text></svg>
            </span>
            <span>Zalo</span>
          </a>
          <a id="linkMsg" class="btn" target="_blank" rel="noopener" href="#" aria-label="Messenger">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#0099FF"/><path d="M6.5 14.2l4.1-3.1 3.1 3.1 3.3-3.1" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span>Messenger</span>
          </a>
          <a id="linkFan" class="btn" target="_blank" rel="noopener" href="#" aria-label="Fanpage Facebook">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#1877F2"/><path d="M14 8h2V6h-2a3 3 0 0 0-3 3v2H9v2h2v5h2v-5h2l1-2h-3V9a1 1 0 0 1 1-1z" fill="#fff"/></svg>
            </span>
            <span>Fanpage</span>
          </a>
        </div>
      </section>

      <!-- RIGHT: Order Summary -->
      <section class="card">
        <h2 class="title">ƒê∆°n h√†ng</h2>
        <div class="order-code" id="orderCodeDisplay" style="display:none">
          <strong>M√£ ƒë∆°n h√†ng: <span id="currentOrderCode"></span></strong>
        </div>
        <div class="line"><strong>Ti·ªÅn h√†ng</strong><span id="co-subtotal">0ƒë</span></div>
        <div class="line"><span>C√¢n n·∫∑ng</span><span id="co-weight">0 kg</span></div>
        <div class="line"><span>Ph√≠ ship</span><span id="co-ship">0ƒë</span></div>
        <div class="line"><strong>T·ªïng</strong><strong id="co-total">0ƒë</strong></div>
        <div class="muted" id="co-items" style="margin-top:8px"></div>
        <div style="margin-top:12px">
          <button id="placeOrder" class="btn cta">ƒê·∫∑t h√†ng</button>
        </div>
      </section>
    </div>

    <footer>ANARO COFFEE ¬∑ ¬© 2025</footer>
  </div>

  <!-- Success popup -->
  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="okTitle">
    <div class="modal">
      <h3 id="okTitle">üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng</h3>
      <p id="okSub">C·∫£m ∆°n b·∫°n! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá x√°c nh·∫≠n s·ªõm nh·∫•t.</p>
      <div class="order-code">
        <strong>M√£ ƒë∆°n h√†ng c·ªßa b·∫°n: <span id="successOrderCode"></span></strong>
      </div>
      <div class="row">
        <a class="btn" href="index.html">‚Üê Ti·∫øp t·ª•c mua</a>
        <a id="okZalo" class="btn" target="_blank" rel="noopener">Zalo</a>
        <a id="okMsg" class="btn" target="_blank" rel="noopener">Messenger</a>
        <a id="okFan" class="btn" target="_blank" rel="noopener">Fanpage</a>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div id="qrBackdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal qr-modal">
      <h3>üí≥ Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      <p>Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin b√™n d∆∞·ªõi:</p>
      
      <div class="transfer-info">
        <div class="bank-option">
          <div class="bank-header">üè¶ <strong>Vietcombank</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë t√†i kho·∫£n:</span>
              <div class="copy-group">
                <code>0721000539033</code>
                <button class="copy-btn" onclick="copyToClipboard('0721000539033')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>H√Ä M·ª∏ AN</strong>
            </div>
          </div>
        </div>

        <div class="bank-option">
          <div class="bank-header">üèõÔ∏è <strong>MBBank</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë t√†i kho·∫£n:</span>
              <div class="copy-group">
                <code>90919091986</code>
                <button class="copy-btn" onclick="copyToClipboard('90919091986')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>H√Ä M·ª∏ AN</strong>
            </div>
          </div>
        </div>

        <div class="bank-option">
          <div class="bank-header">üíú <strong>Momo</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë ƒëi·ªán tho·∫°i:</span>
              <div class="copy-group">
                <code>0918337071</code>
                <button class="copy-btn" onclick="copyToClipboard('0918337071')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>ANARO COFFEE</strong>
            </div>
          </div>
        </div>

        <div class="transfer-amount">
          <div class="amount-info">
            <div class="detail-row">
              <span>S·ªë ti·ªÅn:</span>
              <strong id="transferAmount" style="color: #e74c3c; font-size: 18px;">0ƒë</strong>
            </div>
            <div class="detail-row">
              <span>N·ªôi dung:</span>
              <div class="copy-group">
                <code id="transferContent">ANARO ORDER</code>
                <button class="copy-btn" onclick="copyTransferContent()">üìã</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row" style="margin-top: 16px;">
        <button class="btn" onclick="hideQRModal()">‚Üê Quay l·∫°i</button>
        <button class="btn cta" onclick="confirmTransfer()">‚úì ƒê√£ chuy·ªÉn xong</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config ======
    const FORM_EMAIL = "anmy1909@gmail.com";
    const FORM_ENDPOINT = "https://formsubmit.co/ajax/" + encodeURIComponent(FORM_EMAIL);
    const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbzNeAQvdDfass4qKYdS2C3PZtIVdRhlQp3rICd2a8H4f5qhOeGaq6dEvfiROLue2qjARA/exec";

    const SOCIAL_LINKS = {
      zalo: "https://zalo.me/84918337071",
      messenger: "https://m.me/anarocoffee",
      fanpage: "https://www.facebook.com/anarocoffee/"
    };

    // ƒê·∫ßu s·ªë di ƒë·ªông VN
    const VALID_PREFIXES = [
      '032','033','034','035','036','037','038','039','096','097','098','086',
      '088','091','094','083','084','085','081','082',
      '089','090','093','070','079','077','076','078',
      '092','056','058',
      '099','059',
      '087',
      '055'
    ];

    let currentOrderCode = '';

    // ====== Helpers ======
    const fmt = n => (n||0).toLocaleString('vi-VN') + "ƒë";

    function generateOrderCode() {
      const ts = Date.now().toString();
      const rnd = Math.floor(Math.random()*1000).toString().padStart(3,'0');
      return 'ANARO' + ts.slice(-6) + rnd.slice(-2);
    }

    function showToast(msg, type='info'){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      if(type==='error') t.style.background = '#e74c3c';
      if(type==='success') t.style.background = '#27ae60';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3000);
    }

    function showPopup(){ document.getElementById('backdrop').style.display='flex'; }
    function hidePopup(){ document.getElementById('backdrop').style.display='none'; }

    function showQRModal(){
      const payload = readPayloadFromHash();
      const total = payload ? payload.total : 0;
      currentOrderCode = generateOrderCode();

      document.getElementById('transferAmount').textContent = fmt(total);
      document.getElementById('transferContent').textContent = currentOrderCode;

      document.getElementById('currentOrderCode').textContent = currentOrderCode;
      document.getElementById('orderCodeDisplay').style.display = 'block';

      document.getElementById('qrBackdrop').style.display='flex';
    }
    function hideQRModal(){
      document.getElementById('qrBackdrop').style.display='none';
      document.getElementById('orderCodeDisplay').style.display='none';
    }

    function copyToClipboard(text){
      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(text).then(()=>showToast('‚úÖ ƒê√£ copy: ' + text,'success'))
          .catch(()=>fallbackCopy(text));
      } else fallbackCopy(text);
    }
    function fallbackCopy(text){
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); showToast('‚úÖ ƒê√£ copy: ' + text,'success'); }
      catch{ showToast('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.','error'); }
      document.body.removeChild(ta);
    }
    function copyTransferContent(){
      copyToClipboard(document.getElementById('transferContent').textContent);
    }
    function confirmTransfer(){ hideQRModal(); processOrder(); }

    document.getElementById('backdrop').addEventListener('click', e=>{
      if(e.target.id==='backdrop') hidePopup();
    });
    document.getElementById('qrBackdrop').addEventListener('click', e=>{
      if(e.target.id==='qrBackdrop') hideQRModal();
    });

    function readPayloadFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        return JSON.parse(json);
      }catch(e){
        return {
          items: [{name:'Arabica ƒê√† L·∫°t', size:'250g', grind:'Nguy√™n h·∫°t', qty:2}],
          subtotal:180000, weightKg:0.5, shipping:29000, total:209000
        };
      }
    }

    function bindSocialLinks(){
      document.getElementById('linkZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('linkMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('linkFan').href  = SOCIAL_LINKS.fanpage;
      document.getElementById('okZalo').href   = SOCIAL_LINKS.zalo;
      document.getElementById('okMsg').href    = SOCIAL_LINKS.messenger;
      document.getElementById('okFan').href    = SOCIAL_LINKS.fanpage;
    }

    function renderOrderSummary(payload){
      if(!payload) return;
      const { items=[], subtotal=0, weightKg=0, shipping=0, total=0 } = payload;
      document.getElementById('co-subtotal').textContent = fmt(subtotal);
      document.getElementById('co-weight').textContent   = (weightKg||0).toFixed(2) + " kg";
      document.getElementById('co-ship').textContent     = fmt(shipping);
      document.getElementById('co-total').textContent    = fmt(total);
      const lines = items.map(it=>`‚Ä¢ ${it.name} ‚Äî ${it.size} ‚Äî ${it.grind} √ó ${it.qty}`).join('<br>');
      document.getElementById('co-items').innerHTML = lines || '';
    }

    function validatePhoneNumber(phone){
      const clean = phone.replace(/\D/g,'');
      if(!/^0\d{9}$/.test(clean)){
        return {valid:false, message:'S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0'};
      }
      const prefix = clean.substring(0,3);
      if(!VALID_PREFIXES.includes(prefix)){
        return {valid:false, message:'ƒê·∫ßu s·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá t·∫°i Vi·ªát Nam'};
      }
      return {valid:true, message:''};
    }

    function validateForm(){
      let isValid = true;
      const errors = {};

      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();

      if(!name) errors.recipient = 'T√™n ng∆∞·ªùi nh·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';

      if(!email){
        errors.email = 'Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
      } else if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        errors.email = 'Email kh√¥ng h·ª£p l·ªá';
      }

      if(!phone){
        errors.phone = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
      } else {
        const chk = validatePhoneNumber(phone);
        if(!chk.valid) errors.phone = chk.message;
      }

      if(!address) errors.address = 'ƒê·ªãa ch·ªâ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';

      ['recipient','email','phone','address'].forEach(id=>{
        const input = document.getElementById(id);
        const errEl = document.getElementById(id+'Error');
        const msg = errors[id];
        if(msg){
          isValid = false;
          input?.classList.add('required');
          input?.classList.remove('valid');
          if(errEl) errEl.textContent = msg;
        } else {
          input?.classList.remove('required');
          if(input && input.value.trim()) input.classList.add('valid');
          if(errEl) errEl.textContent = '';
        }
      });

      return isValid;
    }

    function getFormData(){
      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const note = document.getElementById('note').value.trim();
      const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Anh';
      const payment = 'transfer';
      return { name, email, phone, address, note, gender, payment };
    }

    function setupRealTimeValidation(){
      // recipient + address
      ['recipient','address'].forEach(id=>{
        const input = document.getElementById(id);
        const errEl = document.getElementById(id+'Error');
        if(!input) return;
        input.addEventListener('input', function(){
          const v = this.value.trim();
          if(!v){
            this.classList.remove('valid','required');
            if(errEl) errEl.textContent = '';
          } else {
            this.classList.add('valid');
            this.classList.remove('required');
            if(errEl) errEl.textContent = '';
          }
        });
      });

      // email
      const emailInput = document.getElementById('email');
      const emailErr = document.getElementById('emailError');
      if(emailInput){
        emailInput.addEventListener('input', function(){
          const v = this.value.trim();
          if(!v){
            this.classList.remove('valid','required');
            if(emailErr) emailErr.textContent = '';
          } else if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)){
            this.classList.add('required');
            this.classList.remove('valid');
            if(emailErr) emailErr.textContent = 'Email kh√¥ng h·ª£p l·ªá';
          } else {
            this.classList.add('valid');
            this.classList.remove('required');
            if(emailErr) emailErr.textContent = '';
          }
        });
      }

      // phone
      const phoneInput = document.getElementById('phone');
      const phoneErr = document.getElementById('phoneError');
      if(phoneInput){
        phoneInput.addEventListener('input', function(){
          const v = this.value.trim();
          if(!v){
            this.classList.remove('valid','required');
            if(phoneErr) phoneErr.textContent = '';
            return;
          }
          const chk = validatePhoneNumber(v);
          if(!chk.valid){
            this.classList.add('required');
            this.classList.remove('valid');
            if(phoneErr) phoneErr.textContent = chk.message;
          } else {
            this.classList.add('valid');
            this.classList.remove('required');
            if(phoneErr) phoneErr.textContent = '';
          }
        });
      }
    }

    // JSONP to Google Sheets
    function sendToGoogleSheets(orderData){
      return new Promise((resolve,reject)=>{
        try{
          const callbackName = 'googleSheetsCallback_' + Date.now();
          const script = document.createElement('script');

          window[callbackName] = function(response){
            delete window[callbackName];
            if(script.parentNode) document.head.removeChild(script);
            if(response && (response.success || response.result==='success')){
              resolve(response);
            } else {
              reject(new Error(response ? (response.message || response.error || 'Unknown error') : 'Unknown error from Google Sheets'));
            }
          };

          script.onerror = function(){
            delete window[callbackName];
            if(script.parentNode) document.head.removeChild(script);
            reject(new Error('JSONP request failed - network error'));
          };

          const params = new URLSearchParams({
            callback: callbackName,
            data: JSON.stringify(orderData)
          });
          script.src = `${GOOGLE_SHEETS_URL}?${params.toString()}`;
          document.head.appendChild(script);

          setTimeout(()=>{
            if(window[callbackName]){
              delete window[callbackName];
              if(script.parentNode) document.head.removeChild(script);
              reject(new Error('Request timeout - Google Sheets kh√¥ng ph·∫£n h·ªìi'));
            }
          }, 15000);
        }catch(err){ reject(err); }
      });
    }

    async function sendOrderByEmail(orderData){
      try{
        const r = orderData.recipient || {};
        const itemsStr = (orderData.items||[]).map(i=>`${i.name} ‚Äî ${i.size} ‚Äî ${i.grind} √ó ${i.qty}`).join("; ");
        const body = {
          _subject: "ƒê∆°n h√†ng m·ªõi t·ª´ ANARO COFFEE",
          _template: "table",
          _captcha: false,
          _next: window.location.href,
          "M√£ ƒë∆°n h√†ng": orderData.orderCode || 'N/A',
          "Ng∆∞·ªùi nh·∫≠n": `${r.gender||""} ${r.name||""}`.trim(),
          "Email": r.email||"N/A",
          "SƒêT": r.phone||"",
          "ƒê·ªãa ch·ªâ": r.address||"",
          "Ghi ch√∫": r.note||"N/A",
          "Ph∆∞∆°ng th·ª©c TT": "Chuy·ªÉn kho·∫£n",
          "Ti·ªÅn h√†ng": fmt(orderData.subtotal||0),
          "Ph√≠ ship": fmt(orderData.shipping||0),
          "T·ªïng": fmt(orderData.total||0),
          "C√¢n n·∫∑ng (kg)": (orderData.weightKg||0),
          "Chi ti·∫øt": itemsStr,
          "Th·ªùi gian": new Date().toLocaleString('vi-VN')
        };

        const res = await fetch(FORM_ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify(body)
        });
        if(!res.ok){
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        return await res.json().catch(()=>({}));
      }catch(err){ throw err; }
    }

    async function processOrder(){
      const orderBtn = document.getElementById('placeOrder');
      try{
        orderBtn.disabled = true;
        orderBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
        orderBtn.classList.add('loading');

        const payload = readPayloadFromHash() || {};
        const formData = getFormData();

        const orderData = {
          ...payload,
          recipient: formData,
          contact: { ...SOCIAL_LINKS },
          orderTime: new Date().toISOString(),
          orderCode: currentOrderCode || generateOrderCode()
        };

        let sheetsSuccess=false, emailSuccess=false, sheetsError=null, emailError=null;

        try{
          const sheetsResult = await sendToGoogleSheets(orderData);
          console.log('Sheets OK:', sheetsResult);
          sheetsSuccess = true;
        }catch(e){ sheetsError = e; console.error('Sheets ERR:', e); }

        try{
          const emailResult = await sendOrderByEmail(orderData);
          console.log('Email OK:', emailResult);
          emailSuccess = true;
        }catch(e){ emailError = e; console.error('Email ERR:', e); }

        if(sheetsSuccess || emailSuccess){
          document.getElementById('successOrderCode').textContent = orderData.orderCode;

          // clear form
          ['recipient','email','phone','address','note'].forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.value = '';
          });
          ['recipient','email','phone','address'].forEach(id=>{
            const el = document.getElementById(id);
            const er = document.getElementById(id+'Error');
            el?.classList.remove('valid','required');
            if(er) er.textContent = '';
          });
          document.querySelector('input[name="gender"][value="Anh"]').checked = true;
          document.getElementById('orderCodeDisplay').style.display='none';

          showPopup();
          showToast('‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!','success');
        } else {
          let msg = 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ƒë∆°n h√†ng. ';
          if(sheetsError) msg += `Google Sheets: ${sheetsError.message}. `;
          if(emailError) msg += `Email: ${emailError.message}. `;
          msg += 'Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp qua Zalo/Messenger.';
          throw new Error(msg);
        }
      }catch(err){
        console.error('Order error:', err);
        showToast(err.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }finally{
        orderBtn.disabled = false;
        orderBtn.textContent = 'ƒê·∫∑t h√†ng';
        orderBtn.classList.remove('loading');
      }
    }

    document.getElementById('placeOrder').addEventListener('click', ()=>{
      if(!validateForm()){
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc v√† ki·ªÉm tra l·∫°i th√¥ng tin','error');
        return;
      }
      showQRModal();
    });

    // Init
    (function init(){
      bindSocialLinks();
      renderOrderSummary(readPayloadFromHash());
      setupRealTimeValidation();
    })();
  </script>
</body>
</html>
